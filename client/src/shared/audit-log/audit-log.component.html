<p-card>
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center pt-6">
        <h2 class="text-xl font-semibold text-gray-800 header-title">
          Log di Audit - {{ config.data?.tableName || 'Record' }} #{{ config.data?.objectName }}
        </h2>
        <div class="header-title margin-left-auto">
            <p-button
                class="" 
                icon="pi pi-times" 
                severity="secondary"
                (click)="close()"
                pTooltip="Chiudi"
                tooltipPosition="left">
                </p-button>
        </div>
      </div>
    </ng-template>
    
    <ng-template pTemplate="content">
      <!-- Grouped Logs Display -->
      <div class="grouped-logs-container">
        @if (loading) {
          <div class="space-y-4">
            @for (i of [1,2,3]; track i) {
              <div class="log-group">
                <div class="group-header">
                  <p-skeleton height="30px" width="100%" />
                </div>
                <div class="group-content">
                  <p-skeleton height="100px" width="100%" />
                </div>
              </div>
            }
          </div>
        } @else if (groupedLogKeys.length === 0) {
          <div class="flex flex-col items-center gap-4 py-12">
            <i class="pi pi-history text-6xl text-gray-400"></i>
            <p class="text-gray-500 text-lg">Nessun log di audit trovato</p>
          </div>
        } @else {
          @for (groupId of groupedLogKeys; track groupId) {
            <div class="log-group mb-6">
              <!-- Group Header -->
              <div class="group-header bg-gray-100 border border-gray-200 rounded-t-lg p-4">
                <!-- Group Summary Row -->
                <div class="flex justify-between items-center mb-4">
                  <div class="flex items-center gap-4">
                    <div class="group-id">
                      <span class="text-xs text-gray-500">Gruppo</span>
                      <div class="font-mono text-sm font-semibold text-gray-700">#{{ groupId }}</div>
                    </div>
                    <div class="group-timestamp">
                      <span class="text-xs text-gray-500">Data/Ora</span>
                      <div class="text-sm font-medium">
                        {{ getGroupTimestamp(groupedLogs[groupId]) | date:'dd/MM/yyyy HH:mm:ss' }}
                      </div>
                    </div>
                  </div>
                  <div class="group-count margin-left-auto">
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                      {{ groupedLogs[groupId].length }} {{ groupedLogs[groupId].length === 1 ? 'modifica' : 'modifiche' }}
                    </span>
                  </div>
                </div>

                <!-- Shared Operation and Client Info -->
                <div class="grid grid-cols-12 gap-4 pt-4 border-t border-gray-200">
                  <!-- Operation Info -->
                  <div class="col-span-3">
                    <div class="text-xs text-gray-500 mb-1">Operazione</div>
                    <p-tag 
                      [value]="getOperationLabel(getGroupOperation(groupedLogs[groupId]).operation)" 
                      [severity]="getOperationSeverity(getGroupOperation(groupedLogs[groupId]).operation)"
                      [style]="{'font-size': '0.75rem'}">
                    </p-tag>
                  </div>

                  <!-- Client Info -->
                  <div class="col-span-9">
                    <div class="text-xs text-gray-500 mb-1">Client</div>
                    <div class="text-sm">
                      @if (getGroupClientInfo(groupedLogs[groupId]).additional_data) {
                        <div class="mb-2">
                          <strong class="text-gray-700">Dati aggiuntivi:</strong>
                          <div class="json-container mt-1 bg-gray-50 rounded text-xs font-mono overflow-x-auto" [innerHTML]="getGroupClientInfo(groupedLogs[groupId]).additional_data | prettyJson"></div>
                        </div>
                      }
                      <div class="text-gray-500 text-sm">
                        <div><strong>IP:</strong> {{ getGroupClientInfo(groupedLogs[groupId]).ip_address }}</div>
                        <div class="break-all"><strong>User agent:</strong> {{ getGroupClientInfo(groupedLogs[groupId]).user_agent }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Group Content - Consolidated Changes -->
              <div class="group-content border border-t-0 border-gray-200 rounded-b-lg p-6">
                <div class="consolidated-changes m-2">
                  <!-- Show consolidated field changes if any -->
                  @if (getGroupOldValues(groupedLogs[groupId]) || getGroupNewValues(groupedLogs[groupId])) {
                    <div class="changes-comparison grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- Consolidated Old Values -->
                      @if (getGroupOldValues(groupedLogs[groupId])) {
                        <div class="change-item old-change">
                          <div class="change-header">
                            <i class="pi pi-arrow-left text-red-500 mr-2"></i>
                            <span class="change-label">Valori precedenti</span>
                            <span class="field-count">{{ getObjectKeysLength(getGroupOldValues(groupedLogs[groupId])) }} campi</span>
                          </div>
                          <div class="json-container old-values" [innerHTML]="getGroupOldValues(groupedLogs[groupId]) | prettyJson"></div>
                        </div>
                      }

                      <!-- Consolidated New Values -->
                      @if (getGroupNewValues(groupedLogs[groupId])) {
                        <div class="change-item new-change">
                          <div class="change-header">
                            <i class="pi pi-arrow-right text-green-500 mr-2"></i>
                            <span class="change-label">Nuovi valori</span>
                            <span class="field-count">{{ getObjectKeysLength(getGroupNewValues(groupedLogs[groupId])) }} campi</span>
                          </div>
                          <div class="json-container new-values" [innerHTML]="getGroupNewValues(groupedLogs[groupId]) | prettyJson"></div>
                        </div>
                      }
                    </div>
                  }

                  <!-- Show consolidated record changes if any -->
                  @if (getGroupOldRecord(groupedLogs[groupId]) || getGroupNewRecord(groupedLogs[groupId])) {
                    <div class="record-changes mt-4">
                      @if (getGroupOldRecord(groupedLogs[groupId])) {
                        <div class="change-item old-change mb-4">
                          <div class="change-header">
                            <i class="pi pi-trash text-red-500 mr-2"></i>
                            <span class="change-label">Record eliminato</span>
                          </div>
                          <div class="json-container old-record" [innerHTML]="getGroupOldRecord(groupedLogs[groupId]) | prettyJson"></div>
                        </div>
                      }

                      @if (getGroupNewRecord(groupedLogs[groupId])) {
                        <div class="change-item new-change">
                          <div class="change-header">
                            <i class="pi pi-plus text-green-500 mr-2"></i>
                            <span class="change-label">Record creato</span>
                          </div>
                          <div class="json-container new-record" [innerHTML]="getGroupNewRecord(groupedLogs[groupId]) | prettyJson"></div>
                        </div>
                      }
                    </div>
                  }

                  <!-- Show message if no changes to display -->
                  @if (!getGroupOldValues(groupedLogs[groupId]) && !getGroupNewValues(groupedLogs[groupId]) && !getGroupOldRecord(groupedLogs[groupId]) && !getGroupNewRecord(groupedLogs[groupId])) {
                    <div class="no-changes text-center py-8">
                      <i class="pi pi-info-circle text-4xl text-gray-400 mb-2"></i>
                      <p class="text-gray-500">Nessun dettaglio di cambiamento disponibile</p>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        }
      </div>

    </ng-template>
  </p-card>