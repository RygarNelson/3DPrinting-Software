<p-card>
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center pt-6">
        <h2 class="text-xl font-semibold text-gray-800 header-title">
          Log di Audit - {{ config.data?.tableName || 'Record' }} #{{ config.data?.objectName }}
        </h2>
        <div class="header-title margin-left-auto">
            <p-button
                class="" 
                icon="pi pi-times" 
                severity="secondary"
                (click)="close()"
                pTooltip="Chiudi"
                tooltipPosition="left">
                </p-button>
        </div>
      </div>
    </ng-template>
    
    <ng-template pTemplate="content">
      <!-- Grouped Logs Display -->
      <div class="grouped-logs-container">
        @if (loading) {
          <div class="space-y-4">
            @for (i of [1,2,3]; track i) {
              <div class="log-group">
                <div class="group-header">
                  <p-skeleton height="30px" width="100%" />
                </div>
                <div class="group-content">
                  <p-skeleton height="100px" width="100%" />
                </div>
              </div>
            }
          </div>
        } @else if (groupedLogKeys.length === 0) {
          <div class="flex flex-col items-center gap-4 py-12">
            <i class="pi pi-history text-6xl text-gray-400"></i>
            <p class="text-gray-500 text-lg">Nessun log di audit trovato</p>
          </div>
        } @else {
          @for (groupId of groupedLogKeys; track groupId) {
            <div class="log-group mb-6">
              <!-- Group Header -->
              <div class="group-header bg-gray-100 border border-gray-200 rounded-t-lg p-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-4">
                    <div class="group-id">
                      <span class="text-xs text-gray-500">Gruppo</span>
                      <div class="font-mono text-sm font-semibold text-gray-700">#{{ groupId }}</div>
                    </div>
                    <div class="group-timestamp">
                      <span class="text-xs text-gray-500">Data/Ora</span>
                      <div class="text-sm font-medium">
                        {{ getGroupTimestamp(groupedLogs[groupId]) | date:'dd/MM/yyyy HH:mm:ss' }}
                      </div>
                    </div>
                    <div class="group-operations">
                      <span class="text-xs text-gray-500">Operazioni</span>
                      <div class="text-sm font-medium">{{ getGroupOperationSummary(groupedLogs[groupId]) }}</div>
                    </div>
                  </div>
                  <div class="group-count margin-left-auto">
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                      {{ groupedLogs[groupId].length }} {{ groupedLogs[groupId].length === 1 ? 'modifica' : 'modifiche' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Group Content -->
              <div class="group-content border border-t-0 border-gray-200 rounded-b-lg">
                @for (log of groupedLogs[groupId]; track log.id) {
                  <div class="log-entry border-b border-gray-100 last:border-b-0 p-4">
                    <div class="grid grid-cols-12 gap-4">
                      <!-- Operation -->
                      <div class="col-span-2">
                        <div class="text-xs text-gray-500 mb-1">Operazione</div>
                        <p-tag 
                          [value]="getOperationLabel(log.operation)" 
                          [severity]="getOperationSeverity(log.operation)"
                          [style]="{'font-size': '0.75rem'}">
                        </p-tag>
                      </div>

                      <!-- Client Info -->
                      <div class="col-span-3">
                        <div class="text-xs text-gray-500 mb-1">Client</div>
                        <div class="text-sm">
                          @if (log.additional_data) {
                            <div class="mb-2">
                              <strong class="text-gray-700">Dati aggiuntivi:</strong>
                              <div class="json-container mt-1 bg-gray-50 rounded text-xs font-mono overflow-x-auto" [innerHTML]="log.additional_data | prettyJson"></div>
                            </div>
                          }
                          <div class="text-gray-500 text-sm">
                            <div><strong>IP:</strong> {{ log.ip_address }}</div>
                            <div class="break-all"><strong>User agent:</strong> {{ log.user_agent }}</div>
                          </div>
                        </div>
                      </div>

                      <!-- Details -->
                      <div class="col-span-7">
                        <div class="text-xs text-gray-500 mb-2">Dettagli</div>
                        <div class="details-content">
                          @if (log.old_value || log.new_value) {
                            <div class="changes-container">
                              @if (log.old_value) {
                                <div class="change-item old-change">
                                  <div class="change-header">
                                    <i class="pi pi-arrow-left text-red-500 mr-2"></i>
                                    <span class="change-label">Vecchi valori</span>
                                    @if (log.field_name) {
                                      <span class="field-name-inline">{{ log.field_name }}</span>
                                    }
                                  </div>
                                  <div class="json-container old-values" [innerHTML]="log.old_value | prettyJson"></div>
                                </div>
                              }
                              @if (log.new_value) {
                                <div class="change-item new-change">
                                  <div class="change-header">
                                    <i class="pi pi-arrow-right text-green-500 mr-2"></i>
                                    <span class="change-label">Nuovi valori</span>
                                    @if (log.field_name) {
                                      <span class="field-name-inline">{{ log.field_name }}</span>
                                    }
                                  </div>
                                  <div class="json-container new-values" [innerHTML]="log.new_value | prettyJson"></div>
                                </div>
                              }
                            </div>
                          } @else if (log.old_record) {
                            <div class="change-item old-change">
                              <div class="change-header">
                                <i class="pi pi-trash text-red-500 mr-2"></i>
                                <span class="change-label">Vecchio record</span>
                              </div>
                              <div class="json-container old-record" [innerHTML]="log.old_record | prettyJson"></div>
                            </div>
                          } @else if (log.new_record) {
                            <div class="change-item new-change">
                              <div class="change-header">
                                <i class="pi pi-plus text-green-500 mr-2"></i>
                                <span class="change-label">Nuovo record</span>
                              </div>
                              <div class="json-container new-record" [innerHTML]="log.new_record | prettyJson"></div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>

    </ng-template>
  </p-card>