<div class="p-4">
  <p-card>
    <ng-template pTemplate="header">
      <div
        class="flex items-center gap-2"
        [ngClass]="{
          'flex-col w-full': applicationState.isMobile()
        }">
        <h2 class="text-xl font-semibold text-gray-800 pt-6 header-title">Gestione Vendite</h2>
        <div
          class="header-title"
          [ngClass]="{
            'margin-left-auto': !applicationState.isMobile(),
            'flex flex-col w-full': applicationState.isMobile()
          }">
          @if (!applicationState.isMobile()) {
            <h5 class="text-lg font-semibold">
              Ultimi 3 mesi / Saldo: {{ ultimiTreMesi | currency: 'EUR' }}
              <i class="pi pi-info-circle info-icon" tooltipPosition="bottom" [pTooltip]="'Il saldo viene calcolato come la somma delle vendite meno le spese, senza considerare le vendite in sospeso'"></i> - In Sospeso:
              {{ ultimiTreMesiSospese | currency: 'EUR' }} <i class="pi pi-info-circle info-icon" tooltipPosition="bottom" [pTooltip]="'Il totale delle vendite in sospeso, senza considerare le spese'"></i>
            </h5>
          } @else {
            <h5 class="text-lg font-semibold">Ultimi 3 mesi</h5>
            <h5 class="text-lg font-semibold">
              Saldo: {{ ultimiTreMesi | currency: 'EUR' }} <i class="pi pi-info-circle info-icon" tooltipPosition="bottom" [pTooltip]="'Il saldo viene calcolato come la somma delle vendite meno le spese, senza considerare le vendite in sospeso'"></i>
            </h5>
            <h5 class="text-lg font-semibold">
              In Sospeso: {{ ultimiTreMesiSospese | currency: 'EUR' }} <i class="pi pi-info-circle info-icon" tooltipPosition="bottom" [pTooltip]="'Il totale delle vendite in sospeso, senza considerare le spese'"></i>
            </h5>
          }
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="content">
      <!-- Table -->
      <p-table
        #dataTable
        currentPageReportTemplate="Mostrando da {first} a {last} di {totalRecords} vendite"
        class="p-datatable-sm"
        [value]="vendite"
        [paginator]="true"
        [rows]="filtri.limit"
        [totalRecords]="totalRecords"
        [first]="filtri.offset"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        dataKey="id"
        [expandedRowKeys]="expandedRows"
        [(selection)]="selectedVendite"
        [lazy]="true"
        (onLazyLoad)="loadData($event)"
        [loading]="loading">
        <ng-template pTemplate="caption">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mt-4">
            <!-- Search Section -->
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
              <p-iconfield iconPosition="left" class="w-full">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input #searchInput pInputText type="text" placeholder="Cerca vendite..." class="w-full" [(ngModel)]="filtri.search" (ngModelChange)="dataTable.filterGlobal($event, 'contains')" />
              </p-iconfield>
              @if (applicationState.isMobile()) {
                <button pButton label="Filtri" class="p-button-outlined w-full" icon="pi pi-filter" (click)="toggleSidebarFilters()"></button>
              }
            </div>

            <!-- Action Buttons Section -->
            <div class="flex items-center gap-2 justify-end sm:justify-start w-full sm:w-auto">
              <p-menu #menu appendTo="body" [model]="multipleAzioni" [popup]="true"></p-menu>
              <p-button label="Azioni" [loading]="loading" [icon]="menu.visible ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" (onClick)="menu.toggle($event)" class="flex-1 sm:flex-none" />
              <p-button icon="pi pi-plus" label="Nuova Vendita" [loading]="loading" severity="success" (click)="addNewVendita()" pTooltip="Aggiungi nuova vendita" tooltipPosition="top" class="flex-1 sm:flex-none" />
            </div>
          </div>
        </ng-template>

        <!-- ID Column -->
        <ng-template #header>
          <tr>
            <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
            @if (applicationState.isMobile()) {
              <th></th>
            } @else {
              <th></th>
              <th pSortableColumn="id" style="width: 150px">
                Numero
                <p-sortIcon field="id" />
                <p-columnFilter field="id" [type]="'numeric'" display="menu" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false" />
              </th>
              <th pSortableColumn="data_vendita" style="width: 160px">
                Data
                <p-sortIcon field="data_vendita" />
                <p-columnFilter field="data_vendita" [type]="'date'" display="menu" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false" />
              </th>
              <th pSortableColumn="data_scadenza" style="width: 160px">
                Scadenza
                <p-sortIcon field="data_scadenza" />
                <p-columnFilter field="data_scadenza" [type]="'date'" display="menu" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false" />
              </th>
              <th pSortableColumn="data_scadenza_spedizione" style="width: 250px">
                Scadenza Spedizione
                <p-sortIcon field="data_scadenza_spedizione" />
                <p-columnFilter field="data_scadenza_spedizione" [type]="'date'" display="menu" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false" />
              </th>
              <th>
                Cliente
                <p-columnFilter field="cliente_id" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false">
                  <ng-template #filter let-value let-filter="filterCallback">
                    <form-input-select cliente-lookup property="cliente_id" label="Cliente" [(ngModel)]="filtri.cliente_id" (ngModelChange)="filter($event)" />
                  </ng-template>
                </p-columnFilter>
              </th>
              <th>
                Conto Bancario
                <p-columnFilter field="conto_bancario_id" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false">
                  <ng-template #filter let-value let-filter="filterCallback">
                    <form-input-select conto-bancario-lookup property="conto_bancario_id" label="Conto Bancario" [(ngModel)]="filtri.conto_bancario_id" (ngModelChange)="filter($event)" />
                  </ng-template>
                </p-columnFilter>
              </th>
              <th style="min-width: 200px">Dettagli</th>
              <th pSortableColumn="totale_vendita" style="width: 200px">
                Totale
                <p-sortIcon field="totale_vendita" />
                <p-columnFilter field="totale_vendita" [type]="'numeric'" currency="EUR" display="menu" minFractionDigits="2" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false" />
              </th>
              <th style="width: 270px">
                Stato
                <p-columnFilter display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" [showApplyButton]="false" showClearButton="false">
                  <ng-template #filter let-value let-filter="filterCallback">
                    <div class="grid grid-cols-1 gap-2 w-full" style="width: 300px">
                      <form-input-select vendita-stato-spedizione-lookup property="stato_spedizione" label="Stato Spedizione" [filter]="false" [(ngModel)]="filtri.stato_spedizione" (ngModelChange)="filter($event)">
                        <ng-template #selectedItem let-item>
                          <vendita-stato class="w-full" [stato_spedizione]="filtri.stato_spedizione" [isInSelect]="true" />
                        </ng-template>
                        <ng-template #item let-item>
                          <vendita-stato class="w-full" [stato_spedizione]="item.id" [isInSelect]="true" />
                        </ng-template>
                      </form-input-select>
                      <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" label="Stato Stampa" [filter]="false" [(ngModel)]="filtri.stato_stampa" (ngModelChange)="filter($event)">
                        <ng-template #selectedItem let-item>
                          <vendita-dettaglio-stato class="w-full" [stato_stampa]="filtri.stato_stampa" [isInSelect]="true" />
                        </ng-template>
                        <ng-template #item let-item>
                          <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
                        </ng-template>
                      </form-input-select>
                      <form-input-radiobutton [label]="'In Scadenza'" [property]="'in_scadenza'" [name]="'scadenza'" [radioButtonValue]="true" [(ngModel)]="filtri.isInScadenza" (ngModelChange)="filterRadioButton('in_scadenza')" />
                      <form-input-radiobutton [label]="'Scaduto'" [property]="'scaduto'" [name]="'scadenza'" [radioButtonValue]="true" [(ngModel)]="filtri.isScaduto" (ngModelChange)="filterRadioButton('scaduto')" />
                    </div>
                  </ng-template>
                </p-columnFilter>
              </th>
              <th style="width: 120px"></th>
            }
          </tr>
        </ng-template>

        <!-- Data Rows -->
        <ng-template #body let-vendita let-expanded="expanded">
          <tr
            [ngClass]="{
              'in-scadenza': vendita.isInScadenza,
              scaduto: vendita.isScaduto,
              'highlight-row': vendita.id == venditaHighlight
            }">
            <td>
              <div class="flex flex-col items-center">
                <p-tableCheckbox [value]="vendita" />
                @if (applicationState.isMobile()) {
                  <p-button type="button" pRipple [pRowToggler]="vendita" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                }
              </div>
            </td>
            @if (!applicationState.isMobile()) {
              <td>
                <p-button type="button" pRipple [pRowToggler]="vendita" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
              </td>
            }
            @if (applicationState.isMobile()) {
              <td>
                <div class="flex flex-col gap-3 p-3">
                  <div class="grid grid-cols-1 gap-2">
                    <mobile-card-item icon="pi-hashtag" label="Numero" [value]="vendita.id" />
                    <mobile-card-item icon="pi-calendar" label="Data" [value]="vendita.data_vendita | date: 'dd/MM/yyyy'" />
                    <mobile-card-item icon="pi-user" label="Cliente" [value]="vendita.cliente?.etichetta" />
                    <mobile-card-item icon="pi-credit-card" label="Conto" [value]="vendita.conto_bancario?.iban" [valueClass]="'truncate max-w-[200px]'" />
                    <mobile-card-item icon="pi-calendar" label="Scadenza" [value]="vendita.data_scadenza | date: 'dd/MM/yyyy'" />
                    <mobile-card-item icon="pi-send" label="Scadenza Spedizione" [value]="vendita.data_scadenza_spedizione | date: 'dd/MM/yyyy'" />
                  </div>

                  <div class="bg-blue-50/50 p-2 rounded-md">
                    <div class="text-[10px] text-blue-600 uppercase font-bold mb-1 flex items-center gap-1"><i class="pi pi-list text-[10px] mr-1"></i> Articoli</div>
                    @if (vendita.dettagli && vendita.dettagli.length > 0) {
                      <div class="flex flex-wrap gap-1">
                        @for (dettaglio of vendita.dettagli; track dettaglio.id) {
                          <span class="text-[11px] bg-white border border-blue-100 text-gray-700 px-2 py-0.5 rounded-sm">
                            {{ dettaglio.modello?.nome || dettaglio.descrizione }}
                            <span class="text-blue-500 font-bold">x{{ dettaglio.quantita }}</span>
                          </span>
                        }
                      </div>
                    } @else {
                      <span class="text-[11px] text-gray-400 italic">Nessun dettaglio</span>
                    }
                  </div>

                  <div class="flex flex-col gap-2 mt-1 pt-2">
                    <div class="flex items-center justify-between">
                      <span class="text-[10px] text-gray-500 uppercase font-bold tracking-tight">Totale</span>
                      <span class="text-lg font-bold text-gray-900 leading-none">{{ vendita.totale_vendita | currency: 'EUR' }}</span>
                    </div>
                    <div>
                      <form-input-select vendita-stato-spedizione-lookup property="stato_spedizione" [filter]="false" [showClear]="false" [(ngModel)]="vendita.stato_spedizione" (ngModelChange)="modificaStatoVendita(vendita)">
                        <ng-template #selectedItem let-item>
                          <vendita-stato class="w-full" [stato_spedizione]="vendita.stato_spedizione" [isInSelect]="true" />
                        </ng-template>
                        <ng-template #item let-item>
                          <vendita-stato class="w-full" [stato_spedizione]="item.id" [isInSelect]="true" />
                        </ng-template>
                      </form-input-select>
                    </div>
                  </div>

                  <div class="flex justify-end gap-1 mt-1 pb-2">
                    <ng-container *ngTemplateOutlet="venditaActionButtons; context: { vendita: vendita }" />
                  </div>
                </div>
              </td>
            } @else {
              <td class="font-medium">{{ vendita.id }}</td>
              <td class="font-medium">{{ vendita.data_vendita | date: 'dd/MM/yyyy' }}</td>
              <td>{{ vendita.data_scadenza | date: 'dd/MM/yyyy' }}</td>
              <td>{{ vendita.data_scadenza_spedizione | date: 'dd/MM/yyyy' }}</td>
              <td>{{ vendita.cliente?.etichetta }}</td>
              <td>{{ vendita.conto_bancario?.iban }}</td>
              <td>
                @if (vendita.dettagli && vendita.dettagli.length > 0) {
                  <ul class="flex flex-col gap-1">
                    @for (dettaglio of vendita.dettagli; track dettaglio.id) {
                      <li class="flex items-center gap-2">
                        <div class="status-rectangle" [style.background-color]="dettaglio.stato_stampa | venditaDettaglioStatoStampaColor" [pTooltip]="dettaglio.stato_stampa | venditaDettaglioStatoStampaText" tooltipPosition="top">
                          <i class="status-rectangle-icon" [ngClass]="dettaglio.stato_stampa | venditaDettaglioStatoStampaIcon"> </i>
                        </div>
                        <span class="text-sm">
                          @if (dettaglio.modello) {
                            {{ dettaglio.modello?.nome }} {{ dettaglio.stampa_is_pezzo_singolo ? '(Pezzo singolo)' : '' }} {{ dettaglio.stampa_is_parziale ? '(Parziale)' : '' }}
                          } @else {
                            {{ dettaglio.descrizione }} {{ dettaglio.stampa_is_pezzo_singolo ? '(Pezzo singolo)' : '' }} {{ dettaglio.stampa_is_parziale ? '(Parziale)' : '' }}
                          }
                        </span>
                      </li>
                    }
                  </ul>
                } @else {
                  <p class="text-gray-500">Nessun dettaglio</p>
                }
              </td>
              <td>{{ vendita.totale_vendita | currency: 'EUR' }}</td>
              <td>
                <form-input-select vendita-stato-spedizione-lookup property="stato_spedizione" [filter]="false" [showClear]="false" [(ngModel)]="vendita.stato_spedizione" (ngModelChange)="modificaStatoVendita(vendita)">
                  <ng-template #selectedItem let-item>
                    <vendita-stato class="w-full" [stato_spedizione]="vendita.stato_spedizione" [isInSelect]="true" />
                  </ng-template>
                  <ng-template #item let-item>
                    <vendita-stato class="w-full" [stato_spedizione]="item.id" [isInSelect]="true" />
                  </ng-template>
                </form-input-select>
              </td>
              <td class="text-center">
                <ng-container *ngTemplateOutlet="venditaActionButtons; context: { vendita: vendita }" />
              </td>
            }
          </tr>
        </ng-template>
        <ng-template #expandedrow let-vendita>
          <tr>
            <td colspan="12">
              <ng-container *ngTemplateOutlet="venditaDettagli; context: { vendita: vendita }" />
              <ng-container *ngTemplateOutlet="venditaBasette; context: { vendita: vendita }" />
            </td>
          </tr>
        </ng-template>

        <!-- Empty State -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="11" class="text-center py-8">
              <div class="flex flex-col items-center gap-2">
                <i class="pi pi-inbox text-4xl text-gray-400"></i>
                <p class="text-gray-500">Nessuna vendita trovata</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-template>
  </p-card>

  <p-confirmDialog #confirmDialogModificaLinkTracciamento key="modificaLinkTracciamentoDialog" [visible]="modificaLinkTracciamentoVisible" [dismissableMask]="true" (onHide)="modificaLinkTracciamentoVisible = false">
    <ng-template #headless let-message>
      <div class="p-4">
        <div class="flex flex-col items-center gap-2">
          <p class="text-gray-800">Aggiungi il link tracciamento alla vendita numero {{ modificaLinkTracciamentoModel.venditaId }}</p>
        </div>
        <form-input-text property="link_tracciamento" [(ngModel)]="modificaLinkTracciamentoModel.linkTracciamento" />
        <div class="flex items-center gap-2 mt-6">
          <p-button label="Salva" styleClass="w-32" [disabled]="modificaLinkTracciamentoModel == null || (modificaLinkTracciamentoModel != null && !modificaLinkTracciamentoModel.linkTracciamento)" (onClick)="modificaLinkTracciamento()"></p-button>
          <p-button label="Annulla" [outlined]="true" styleClass="w-32" (onClick)="confirmDialogModificaLinkTracciamento?.hide()"></p-button>
        </div>
      </div>
    </ng-template>
  </p-confirmDialog>

  <p-confirmDialog #confirmDialogModificaContoBancario key="modificaContoBancarioDialog" [visible]="modificaContoBancarioVisible" [dismissableMask]="true" (onHide)="modificaContoBancarioVisible = false">
    <ng-template #headless let-message>
      <div class="p-4">
        <div class="flex flex-col items-center gap-2">
          <p class="text-gray-800">Modifica il conto bancario delle vendite selezionate</p>
        </div>
        <form-input-select conto-bancario-lookup property="conto_bancario_id" [(ngModel)]="modificaContoBancarioModel.conto_bancario_id" />
        <div class="flex items-center gap-2 mt-6">
          <p-button label="Salva" styleClass="w-32" [disabled]="modificaContoBancarioModel == null || (modificaContoBancarioModel != null && !modificaContoBancarioModel.conto_bancario_id)" (onClick)="modificaContoBancarioVendite()"></p-button>
          <p-button label="Annulla" [outlined]="true" styleClass="w-32" (onClick)="confirmDialogModificaContoBancario?.hide()"></p-button>
        </div>
      </div>
    </ng-template>
  </p-confirmDialog>

  <p-confirmDialog #confirmDialogDelete key="deleteVenditaDialog" [visible]="deleteDialogVisible" [dismissableMask]="true" (onHide)="deleteDialogVisible = false">
    <ng-template #headless let-message>
      <div class="p-4">
        <div class="flex flex-col items-center gap-2">
          <i class="pi pi-exclamation-triangle text-4xl text-red-500"></i>
          <p class="text-gray-800 text-center">Sei sicuro di voler eliminare la vendita nr."{{ venditaToDelete?.id }}"?</p>
        </div>
        <div class="flex items-center gap-2 mt-6">
          <p-button label="Si" styleClass="w-32 p-button-danger" icon="pi pi-exclamation-triangle" (onClick)="deleteVendita(venditaToDelete?.id!)"></p-button>
          <p-button label="No" [outlined]="true" styleClass="w-32 p-button-secondary" icon="pi pi-times" (onClick)="confirmDialogDelete?.hide()"></p-button>
        </div>
      </div>
    </ng-template>
  </p-confirmDialog>

  <p-dialog header="Gestione Etichetta Spedizione" [(visible)]="etichettaSpedizioneDialogVisible" [modal]="true" [style]="{ width: '500px' }" [draggable]="false" [resizable]="false" [dismissableMask]="true" (onHide)="venditaForEtichetta = undefined">
    @if (venditaForEtichetta) {
      <div class="flex flex-col gap-4">
        <app-vendita-etichetta-spedizione [venditaId]="venditaForEtichetta.id" [etichettaSpedizione]="venditaForEtichetta.etichetta_spedizione" (onEtichettaChange)="venditaForEtichetta.etichetta_spedizione = $event === null ? undefined : $event">
        </app-vendita-etichetta-spedizione>
      </div>
    }
  </p-dialog>

  <p-drawer [(visible)]="sidebarVisible" position="right" [style]="{ width: '100%', maxWidth: '350px' }">
    <ng-template pTemplate="header">
      <h3 class="text-xl font-bold m-0 text-gray-800">Filtri Avanzati</h3>
    </ng-template>
    <div class="flex flex-col gap-4 p-fluid mt-4">
      <div class="field">
        <label class="font-semibold text-sm mb-1 block">Cliente</label>
        <form-input-select cliente-lookup property="cliente_id" [(ngModel)]="filtri.cliente_id" />
      </div>

      <div class="field">
        <label class="font-semibold text-sm mb-1 block">Conto Bancario</label>
        <form-input-select conto-bancario-lookup property="conto_bancario_id" [(ngModel)]="filtri.conto_bancario_id" />
      </div>

      <div class="field">
        <label class="font-semibold text-sm mb-1 block">Stato Spedizione</label>
        <form-input-select vendita-stato-spedizione-lookup property="stato_spedizione" [filter]="false" [(ngModel)]="filtri.stato_spedizione">
          <ng-template #selectedItem let-item>
            <vendita-stato class="w-full" [stato_spedizione]="filtri.stato_spedizione" [isInSelect]="true" />
          </ng-template>
          <ng-template #item let-item>
            <vendita-stato class="w-full" [stato_spedizione]="item.id" [isInSelect]="true" />
          </ng-template>
        </form-input-select>
      </div>

      <div class="field">
        <label class="font-semibold text-sm mb-1 block">Stato Stampa</label>
        <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" [filter]="false" [(ngModel)]="filtri.stato_stampa">
          <ng-template #selectedItem let-item>
            <vendita-dettaglio-stato class="w-full" [stato_stampa]="filtri.stato_stampa" [isInSelect]="true" />
          </ng-template>
          <ng-template #item let-item>
            <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
          </ng-template>
        </form-input-select>
      </div>

      <div class="field">
        <label class="font-semibold text-sm mb-1 block">Data Vendita</label>
        <p-datepicker [(ngModel)]="filtri.data_vendita!.value" dateFormat="dd/mm/yy" appendTo="body" [showIcon]="true" (onSelect)="filtri.data_vendita!.operator = 'dateIs'" />
      </div>

      <div class="flex flex-col gap-3 mt-2">
        <div class="flex items-center gap-2">
          <p-checkbox [(ngModel)]="filtri.isInScadenza" [binary]="true" inputId="in_scadenza" />
          <label for="in_scadenza" class="text-sm">In Scadenza</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox [(ngModel)]="filtri.isScaduto" [binary]="true" inputId="scaduto" />
          <label for="scaduto" class="text-sm">Scaduto</label>
        </div>
      </div>

      <div class="flex gap-2 mt-6">
        <p-button label="Applica" class="flex-1" icon="pi pi-check" (onClick)="applicaSidebarFiltri()" />
        <p-button label="Reset" class="flex-1 p-button-outlined p-button-secondary" icon="pi pi-refresh" (onClick)="resetSidebarFiltri()" />
      </div>
    </div>
  </p-drawer>
</div>

<ng-template #venditaActionButtons let-vendita="vendita">
  <div class="flex justify-end gap-2 mt-2">
    @if (vendita.link_tracciamento) {
      <p-button icon="pi pi-link" severity="success" size="small" [disabled]="!vendita.link_tracciamento" (click)="copiaLinkTracciamento(vendita)" pTooltip="Copia link tracciamento" tooltipPosition="top" [loading]="loading" />
    } @else {
      <p-button icon="pi pi-receipt" severity="success" size="small" [disabled]="vendita.link_tracciamento" (click)="openModificaLinkTracciamento(vendita)" pTooltip="Aggiungi link tracciamento" tooltipPosition="top" [loading]="loading" />
    }

    <p-button icon="pi pi-file-pdf" severity="warn" size="small" (click)="openEtichettaSpedizioneDialog(vendita)" pTooltip="Gestione Etichetta Spedizione" tooltipPosition="top" [loading]="loading" />
    <p-button icon="pi pi-history" severity="secondary" size="small" (click)="viewAuditLog(vendita)" pTooltip="Visualizza log di audit" tooltipPosition="top" [loading]="loading" />
    <p-button icon="pi pi-pencil" severity="info" size="small" (click)="editVendita(vendita)" pTooltip="Modifica vendita" tooltipPosition="top" [loading]="loading" />
    <p-button icon="pi pi-trash" severity="danger" size="small" (click)="confirmDelete($event, vendita)" pTooltip="Elimina vendita" tooltipPosition="top" [loading]="loading" />
  </div>
</ng-template>

<ng-template #venditaDettagli let-vendita="vendita">
  <div class="my-3">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Dettagli</h3>
    @if (applicationState.isMobile()) {
      <div class="flex flex-col gap-3">
        @if (!vendita.dettagli || vendita.dettagli.length === 0) {
          <div class="text-center py-6">
            <i class="pi pi-inbox text-4xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">Non ci sono dettagli per questa vendita</p>
          </div>
        }
        @for (dettaglio of vendita.dettagli; track dettaglio.id) {
          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col gap-2 text-sm text-gray-700">
              <div>
                <div class="text-gray-500">Modello / Descrizione</div>
                <div class="font-medium">
                  @if (dettaglio?.modello) {
                    {{ dettaglio?.modello?.nome }}
                  } @else {
                    {{ dettaglio?.descrizione }}
                  }
                </div>
              </div>
              <div class="grid grid-cols-2 gap-x-3 gap-y-1">
                <div class="text-gray-500">Stampante</div>
                <div>{{ dettaglio?.stampante?.nome }}</div>
                <div class="text-gray-500">Quantità</div>
                <div>{{ dettaglio?.quantita }}</div>
                <div class="text-gray-500">Prezzo</div>
                <div class="flex flex-col">
                  <span>{{ dettaglio?.prezzo | currency: 'EUR' }}</span>
                </div>
              </div>
              <div>
                <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" [filter]="false" [showClear]="false" [(ngModel)]="dettaglio.stato_stampa" (ngModelChange)="modificaStatoDettaglio(dettaglio)">
                  <ng-template #selectedItem let-item>
                    <vendita-dettaglio-stato class="w-full" [stato_stampa]="dettaglio.stato_stampa" [isInSelect]="true" />
                  </ng-template>
                  <ng-template #item let-item>
                    <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
                  </ng-template>
                </form-input-select>
              </div>
            </div>
          </div>
        }
      </div>
    } @else {
      <p-table showGridlines [value]="vendita.dettagli">
        <ng-template #header>
          <tr>
            <th class="text-center">Modello / Descrizione</th>
            <th class="text-center">Stampante</th>
            <th class="text-center">Quantità</th>
            <th class="text-center">Prezzo</th>
            <th class="text-center" style="width: 300px">Stato Stampa</th>
          </tr>
        </ng-template>
        <ng-template #body let-dettaglio>
          <tr>
            <td class="text-center">
              @if (dettaglio?.modello) {
                {{ dettaglio?.modello?.nome }}
              } @else {
                {{ dettaglio?.descrizione }}
              }
            </td>
            <td class="text-center">{{ dettaglio?.stampante?.nome }}</td>
            <td class="text-center">{{ dettaglio?.quantita }}</td>
            <td class="text-center">
              <div class="flex flex-col items-center gap-2">
                <span>{{ dettaglio?.prezzo | currency: 'EUR' }}</span>
              </div>
            </td>
            <td class="text-center">
              <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" [filter]="false" [showClear]="false" [(ngModel)]="dettaglio.stato_stampa" (ngModelChange)="modificaStatoDettaglio(dettaglio)">
                <ng-template #selectedItem let-item>
                  <vendita-dettaglio-stato class="w-full" [stato_stampa]="dettaglio.stato_stampa" [isInSelect]="true" />
                </ng-template>
                <ng-template #item let-item>
                  <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
                </ng-template>
              </form-input-select>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <td colspan="5" class="text-center py-8">
            <div class="flex flex-col items-center gap-2">
              <i class="pi pi-inbox text-4xl text-gray-400"></i>
              <p class="text-gray-500">Non ci sono dettagli per questa vendita</p>
            </div>
          </td>
        </ng-template>
      </p-table>
    }
  </div>
</ng-template>

<ng-template #venditaBasette let-vendita="vendita">
  <div class="my-3">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Basette</h3>
    @if (applicationState.isMobile()) {
      <div class="flex flex-col gap-3">
        @if (!vendita.basette || vendita.basette.length === 0) {
          <div class="text-center py-6">
            <i class="pi pi-inbox text-4xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">Non ci sono basette per questa vendita</p>
          </div>
        }
        @for (basetta of vendita.basette; track basetta.id) {
          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col gap-2 text-sm text-gray-700">
              <div class="grid grid-cols-2 gap-x-3 gap-y-1">
                <div class="text-gray-500">Dimensione</div>
                <div>{{ basetta?.dimensione }}</div>
                <div class="text-gray-500">Quantità</div>
                <div>{{ basetta?.quantita }}</div>
              </div>
              <div>
                <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" [filter]="false" [showClear]="false" [(ngModel)]="basetta.stato_stampa" (ngModelChange)="modificaStatoBasetta(basetta)">
                  <ng-template #selectedItem let-item>
                    <vendita-dettaglio-stato class="w-full" [stato_stampa]="basetta.stato_stampa" [isInSelect]="true" />
                  </ng-template>
                  <ng-template #item let-item>
                    <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
                  </ng-template>
                </form-input-select>
              </div>
            </div>
          </div>
        }
      </div>
    } @else {
      <p-table showGridlines [value]="vendita.basette">
        <ng-template #header>
          <tr>
            <th class="text-center">Dimensione</th>
            <th class="text-center">Quantità</th>
            <th class="text-center" style="width: 300px">Stato Stampa</th>
          </tr>
        </ng-template>
        <ng-template #body let-basetta>
          <tr>
            <td class="text-center">
              {{ basetta?.dimensione }}
            </td>
            <td class="text-center">{{ basetta?.quantita }}</td>
            <td class="text-center">
              <form-input-select vendita-dettaglio-stato-stampa-lookup property="stato_stampa" [filter]="false" [showClear]="false" [(ngModel)]="basetta.stato_stampa" (ngModelChange)="modificaStatoBasetta(basetta)">
                <ng-template #selectedItem let-item>
                  <vendita-dettaglio-stato class="w-full" [stato_stampa]="basetta.stato_stampa" [isInSelect]="true" />
                </ng-template>
                <ng-template #item let-item>
                  <vendita-dettaglio-stato class="w-full" [stato_stampa]="item.id" [isInSelect]="true" />
                </ng-template>
              </form-input-select>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <td colspan="3" class="text-center py-8">
            <div class="flex flex-col items-center gap-2">
              <i class="pi pi-inbox text-4xl text-gray-400"></i>
              <p class="text-gray-500">Non ci sono basette per questa vendita</p>
            </div>
          </td>
        </ng-template>
      </p-table>
    }
  </div>
</ng-template>
